# helm template argocd argo/argo-cd --namespace hiru-mgmt-argocd --values upgrade-values.yaml
apiVersionOverrides:
  certmanager: "cert-manager.io/v1"

global:
  domain: "argocd.localtest.me"

configs:
  cm:
    create: true
    url: "http://argocd.localtest.me"

    kustomize.buildOptions: |
      --enable-helm

    resource.customizations: |
      argoproj.io/Application:
        health.lua: |
          hs = {}
          hs.status = "Progressing"
          hs.message = ""
          if obj.status ~= nil then
            if obj.status.health ~= nil then
              hs.status = obj.status.health.status
              if obj.status.health.message ~= nil then
                hs.message = obj.status.health.message
              end
            end
          end
          return hs

      cert-manager.io/Certificate:
        health.lua: |
          hs = {}
          if obj.status ~= nil then
            if obj.status.conditions ~= nil then
              for i, condition in ipairs(obj.status.conditions) do
                if condition.type == "Ready" and condition.status == "False" then
                  hs.status = "Degraded"
                  hs.message = condition.message
                  return hs
                end
                if condition.type == "Ready" and condition.status == "True" then
                  hs.status = "Healthy"
                  hs.message = condition.message
                  return hs
                end
              end
            end
          end

          hs.status = "Progressing"
          hs.message = "Waiting for certificate"
          return hs

      ignoreDifferences: 
        all: |
          jqPathExpressions:
          - 'spec.containers[]?.securityContext.allowPrivilegeEscalation'
          - 'spec.initContainers[]?.securityContext.allowPrivilegeEscalation'
          - 'spec.containers[]?.securityContext.capabilities.drop'
          - 'spec.automountServiceAccountToken'
          - 'automountServiceAccountToken'

    resource.customizations.ignoreDifferences.admissionregistration.k8s.io_MutatingWebhookConfiguration: |
      jqPathExpressions:
      - '.webhooks[]?.clientConfig.caBundle'

    resource.customizations.ignoreDifferences.apiextensions.k8s.io_CustomResourceDefinition: |
      jsonPointers:
      - /spec/conversion/webhook/clientConfig/caBundle

  params:
    application.namespaces: '*'
    server.insecure: true
    controller.status.processors: 100
    controller.operation.processors: 50

server:
  ingress:
    enabled: true
    ingressClassName: "nginx"
    annotations:
      nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    hostname: "argocd.localtest.me"
    tls: false