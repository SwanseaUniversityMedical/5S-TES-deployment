services:

  # ------ TRE Agent - UI -------
  # -----------------------------------

  tre-ui:
    image: harbor.federated-analytics.ac.uk/5s-tes/agent-ui:${DEPLOYMENT_VERSION}
    container_name: treUI
    restart: always
    networks:
      - sub-net
    ports:
      - 8989:8080
    depends_on:
      - tre-api
    environment:
      - TreAPISettings__InternalApiBaseUrl=http://treAPI:8080
      - TreAPISettings__PublicApiBaseUrl=${TreApiPublicUrl}
      - Serilog__SeqServerUrl=http://seq:5341
      - DemoMode=${DemoMode}
      - KeyCloakDemoMode=${KeyCloakDemoMode}
      - TreKeyCloakSettings__Authority=${TreKeyCloakAuthority}
      - TreKeyCloakSettings__MetadataAddress=${TreKeyCloakMetadataAddress}
      - TreKeyCloakSettings__BaseUrl=${TreKeyCloakBaseRealmAddress}
      - TreKeyCloakSettings__ClientId=${TreKeyCloakClientId}
      - TreKeyCloakSettings__ClientSecret=${TreKeyCloakSecret}
      - TreKeyCloakSettings__ValidAudiences=${TreValidAudiences}
      - TreKeyCloakSettings__Proxy=${useproxy}
      - TreKeyCloakSettings__ProxyAddresURL=${proxyurl}
      - sslcookies=${sslcookies}
      - httpsRedirect=${httpsRedirect}
      - TreKeyCloakSettings__AccountManagementURL=${TreAccountManagementURLUI}
      - TreKeyCloakSettings__BypassProxy="treAPI,seq-tre"
      - TreKeyCloakSettings__TokenExpiredAddress=${TreKeyCloakTokenExpiredAddressUI}
      - TreKeyCloakSettings__UseRedirectURL=${TreKeyCloakUseRedirect}
      - TreKeyCloakSettings__RedirectURL=${TreKeyCloakClientUIRedirectURL}

# ------ TRE Agent - API -------
# -----------------------------------
  tre-api:
    image: harbor.federated-analytics.ac.uk/5s-tes/agent-api:${DEPLOYMENT_VERSION}
    container_name: treapi
    restart: always
    networks:
      - sub-net
    ports:
      - 8072:8080
    # This is the volume for the process models to make the changes in the DMN table persistent
    volumes:
      - tre_process_models:/app/ProcessModels
    depends_on:
      postgresql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      minioTRE:
        condition: service_healthy
      vault:
        condition: service_healthy
      orchestration:
        condition: service_healthy
    environment:
      # General settings
      - Features__DemoAllInOne=${DemoMode}
      - Features__EphemeralCredentials=true
      - KeyCloakDemoMode=${KeyCloakDemoMode}
      - DemoModeDefaultP=password123
      - ConnectionStrings__DefaultConnection=Server=postgres;Port=5432;Database=DARE-Tre;Include Error Detail=true;User Id=${PGLOGIN};Password=${PGPASSWORD};TrustServerCertificate=True;
      - ConnectionStrings__CredentialsConnection=Server=postgres;Port=5432;Database=TRE_Credentials;Include Error Detail=true;User Id=${PGLOGIN};Password=${PGPASSWORD};TrustServerCertificate=True;
      - RabbitMQ__HostAddress=rabbitmq
      - Serilog__SeqServerUrl=http://seq:5341
      - DareAPISettings__Address=${SubmissionAPIAddressURL}
      - DataEgressAPISettings__Address=http://DataEgressAPI:8080
      - EnableExternalHangfire=${EnableExternalHangfire}
      - AgentSettings__UseTESK=${UseTESK}
      - JobSettings__scanSchedule=${scanSchedule}
      - JobSettings__syncSchedule=${syncSchedule}
      - AgentSettings__TESKAPIURL=${TesAPIUrl}
      - AgentSettings__TESKOutputBucketPrefix=${TesOutputBucketPrefix}
      - TreName=${TreName}
      # TRE Keycloak settings
      - TreKeyCloakSettings__Authority=${TreKeyCloakAuthority}
      - TreKeyCloakSettings__MetadataAddress=${TreKeyCloakMetadataAddress}
      - TreKeyCloakSettings__BaseUrl=${TreKeyCloakBaseRealmAddress}
      - TreKeyCloakSettings__ClientId=${TreKeyCloakClientId}
      - TreKeyCloakSettings__ClientSecret=${TreKeyCloakSecret}
      - TreKeyCloakSettings__ValidAudiences=${TreValidAudiences}
      - TreKeyCloakSettings__Proxy=${useproxy}
      - TreKeyCloakSettings__ProxyAddresURL=${proxyurl}
      - TreKeyCloakSettings__BypassProxy="treAPI,seq-tre"
      - TreKeyCloakSettings__TokenExpiredAddress=${TreKeyCloakTokenExpiredAddressUI}
      - TreKeyCloakSettings__UseRedirectURL=${TreKeyCloakUseRedirect}
      - TreKeyCloakSettings__RedirectURL=${TreKeyCloakClientUIRedirectURL}
      # Data Egress Keycloak settings
      - DataEgressKeyCloakSettings__Authority=${EgressKeyCloakAuthority}
      - DataEgressKeyCloakSettings__MetadataAddress=${EgressKeyCloakMetadataAddress}
      - DataEgressKeyCloakSettings__BaseUrl=${EgressKeyCloakBaseRealmAddress}
      - DataEgressKeyCloakSettings__ClientId=${EgressKeyCloakClientID}
      - DataEgressKeyCloakSettings__ClientSecret=${EgressKeyCloakSecret}
      - DataEgressKeyCloakSettings__ValidAudiences=${EgressValidAudiences}
      - DataEgressKeyCloakSettings__Proxy=${useproxy}
      - DataEgressKeyCloakSettings__ProxyAddresURL=${proxyurl}
      - DataEgressKeyCloakSettings__BypassProxy="DataEgressUI,treAPI,seq-tre"
      - DataEgressKeyCloakSettings__TokenExpiredAddress=${EgressKeyCloakTokenExpiredAddressUI}
      - DataEgressKeyCloakSettings__UseRedirectURL=${EgressKeyCloakUseRedirect}
      - DataEgressKeyCloakSettings__RedirectURL=${EgressKeyCloakClientUIRedirectURL}
      # Submission API Keycloak settings
      - SubmissionKeyCloakSettings__Authority=${SubmissionAPIKeyCloakAuthority}
      - SubmissionKeyCloakSettings__MetadataAddress=${SubmissionAPIKeyCloakMetadataAddress}
      - SubmissionKeyCloakSettings__BaseUrl=${SubmissionAPIKeyCloakBaseRealmAddress}
      - SubmissionKeyCloakSettings__ClientId=${SubmissionAPIKeyCloakClientId}
      - SubmissionKeyCloakSettings__ClientSecret=${SubmissionAPIKeyCloakSecret}
      - SubmissionKeyCloakSettings__ValidAudiences=${SubmissionAPIValidAudiences}
      - SubmissionKeyCloakSettings__Proxy=${useproxy}
      - SubmissionKeyCloakSettings__ProxyAddresURL=${proxyurl}
      - SubmissionKeyCloakSettings__BypassProxy="treAPI,seq-tre"
      - SubmissionKeyCloakSettings__TokenExpiredAddress=${SubmissionAPIKeyCloakTokenExpiredAddressUI}
      - SubmissionKeyCloakSettings__UseRedirectURL=${SubmissionAPIKeyCloakUseRedirect}
      - SubmissionKeyCloakSettings__RedirectURL=${SubmissionAPIKeyCloakClientUIRedirectURL}
      # MINIO TRE settings
      - MinioTRESettings__Url=http://minioTRE:9000
      - MinioTRESettings__AccessKey=${TreMinioAdminUser}
      - MinioTRESettings__SecretKey=${TreMinioAdminPassword}
      - MinioTRESettings__AdminConsole=http://minioTRE:9001
      - MinioTRESettings__AWSRegion=us-east-1
      # MINIO SUBMISSION settings
      - MinioSubSettings__Url=${submissionMinioUrl}
      - MinioSubSettings__AccessKey=${MinioRootUser}
      - MinioSubSettings__SecretKey=${MinioRootPass}
      - MinioSubSettings__AdminConsole=${submissionMinioAdminConsole}
      - MinioSubSettings__BucketName=testbucket
      - MinioSubSettings__AWSRegion=us-east-1
      # Credentials and DMN settings
      - CredentialAPISettings__StartWebhookUrl=http://connectors:8080/inbound/StartCredentials
      - CredentialAPISettings__RevokeWebhookUrl=http://connectors:8080/inbound/RevokeCredentials
      - DmnPath__Path=/app/ProcessModels
      - TreAPISettings__Address=${TreApiPublicUrl}
      # Vault settings
      - VaultSettings__BaseUrl=http://vault:8200
      - VaultSettings__Token=dev-only-token
      - VaultSettings__TimeoutSeconds=30
      - VaultSettings__SecretEngine=secret
      - VaultSettings__EnableRetry=true
      - VaultSettings__MaxRetryAttempts=3
      # Zeebe settings
      - ZeebeBootstrap__Client__GatewayAddress=orchestration:26500
      - ZeebeBootstrap__Worker__MaxJobsActive=5
      - ZeebeBootstrap__Worker__TimeoutInMilliseconds=500
      - ZeebeBootstrap__Worker__PollIntervalInMilliseconds=50
      - ZeebeBootstrap__Worker__PollingTimeoutInMilliseconds=1000
      - ZeebeBootstrap__Worker__RetryTimeoutInMilliseconds=1000
      # Encryption settings
      - EncryptionSettings__Key=${EncryptionSettingsKey}
      - EncryptionSettings__Base=${EncryptionSettingsBase}


# ----- TRE Agent - Camunda Worker -------
# --------------------------------------------

  TRE-Camunda:
    image: harbor.federated-analytics.ac.uk/5s-tes/credentials-camunda:${DEPLOYMENT_VERSION}
    container_name: TRE-Camunda
    restart: always
    networks:
      - sub-net
    depends_on:
      orchestration:
        condition: service_healthy
      openldap:
        condition: service_healthy
      vault:
        condition: service_healthy
      postgresql:
        condition: service_healthy
    volumes:
      - tre_process_models:/app/ProcessModels
    environment:
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
      - AllowedHosts=*
      - Serilog__SeqServerUrl=http://seq:5341
      - DmnPath__Path=/app/ProcessModels
      # Zeebe Bootstrap settings
      - ZeebeBootstrap__Client__GatewayAddress=orchestration:26500
      - ZeebeBootstrap__Worker__MaxJobsActive=5
      - ZeebeBootstrap__Worker__TimeoutInMilliseconds=500
      - ZeebeBootstrap__Worker__PollIntervalInMilliseconds=50
      - ZeebeBootstrap__Worker__PollingTimeoutInMilliseconds=1000
      - ZeebeBootstrap__Worker__RetryTimeoutInMilliseconds=1000
      # LDAP settings
      - LdapSettings__Host=openldap
      - LdapSettings__Port=389
      - LdapSettings__AdminDn=cn=admin,dc=camundaephemeral,dc=local
      - LdapSettings__AdminPassword=admin
      - LdapSettings__BaseDn=dc=camundaephemeral,dc=local
      - LdapSettings__UserOu=ou=Users
      - LdapSettings__UseSSL=false
      # Vault settings
      - VaultSettings__BaseUrl=http://vault:8200
      - VaultSettings__Token=dev-only-token
      - VaultSettings__TimeoutSeconds=30
      - VaultSettings__SecretEngine=secret
      - VaultSettings__EnableRetry=true
      - VaultSettings__MaxRetryAttempts=3
      - ConnectionStrings__CredentialsConnection=Server=postgres;Port=5432;Database=TRE_Credentials;Include Error Detail=true;User Id=${PGLOGIN};Password=${PGPASSWORD};
      - ConnectionStrings__TREPostgresConnection=Server=${TRE_DATA_SERVER};Port=${TRE_DATA_PORT};Database=${TRE_DATA_DATABASE};Include Error Detail=true;User Id=${TRE_DATA_USER};Password=${TRE_DATA_PASSWORD};
